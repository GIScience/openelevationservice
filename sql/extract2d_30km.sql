EXPLAIN ANALYZE
WITH line AS
(SELECT 'SRID=4326;LINESTRING (8.677842999999999 49.406192, 8.677662 49.406178, 8.677004 49.406125, 8.676931 49.406116, 8.676921999999999 49.406466, 8.676864 49.407734, 8.676847 49.407846, 8.676848 49.407893, 8.67685 49.407924, 8.676852999999999 49.407979, 8.676774999999999 49.40798, 8.676735000000001 49.40798, 8.676696 49.40798, 8.676496999999999 49.40798, 8.676456999999999 49.407979, 8.676126999999999 49.407975, 8.676048 49.407973, 8.675522000000001 49.40796, 8.675314999999999 49.407941, 8.674925999999999 49.407936, 8.674797 49.40794, 8.674702999999999 49.407948, 8.674509 49.407968, 8.674381 49.407979, 8.674255 49.407988, 8.67417 49.407992, 8.674058 49.407995, 8.673818000000001 49.408005, 8.673627 49.408005, 8.673568 49.408004, 8.672806 49.408, 8.672737 49.408001, 8.672599 49.408003, 8.67229 49.408024, 8.672247 49.408027, 8.671775 49.40804, 8.670403 49.408065, 8.670261999999999 49.408068, 8.669843999999999 49.408076, 8.669506 49.408105, 8.669358000000001 49.408117, 8.669314999999999 49.408121, 8.669199000000001 49.408136, 8.668884 49.408169, 8.668654 49.408188, 8.667877000000001 49.408226, 8.666931999999999 49.408266, 8.666380999999999 49.408316, 8.665452 49.408428, 8.664576 49.408594, 8.663678000000001 49.408791, 8.662762000000001 49.409012, 8.658257000000001 49.410211, 8.652422 49.411782, 8.652058 49.411874, 8.649709 49.412468, 8.64944 49.412539, 8.648999999999999 49.412656, 8.646922 49.413204, 8.645289 49.413635, 8.642702 49.414328, 8.642225 49.414455, 8.640844 49.414878, 8.640067999999999 49.415151, 8.639875 49.415278, 8.639756999999999 49.41533, 8.639014 49.415661, 8.638140999999999 49.416059, 8.636801 49.416674, 8.636048000000001 49.417057, 8.634088 49.418167, 8.632631 49.419004, 8.628508 49.421361, 8.627617000000001 49.421818, 8.626923 49.422113, 8.625429 49.422976, 8.623995000000001 49.423801, 8.615728000000001 49.428537, 8.604960999999999 49.434698, 8.602658999999999 49.436017, 8.598223000000001 49.438559, 8.597358 49.439055, 8.596363 49.439626, 8.595212999999999 49.440271, 8.594182 49.440801, 8.593505 49.441122, 8.592275000000001 49.441652, 8.591258 49.442062, 8.589926 49.442552, 8.588939999999999 49.442919, 8.587574999999999 49.443426, 8.586888999999999 49.443682, 8.583408 49.444976, 8.582634000000001 49.445265, 8.58216 49.445442, 8.581664999999999 49.445625, 8.579143999999999 49.446567, 8.577284000000001 49.447259, 8.577090999999999 49.447331, 8.575593 49.447893, 8.575284 49.448006, 8.574851000000001 49.448168, 8.572759 49.448947, 8.571565 49.449391, 8.570582999999999 49.449758, 8.567769 49.450807, 8.565208 49.451761, 8.549555 49.457593, 8.545971 49.458929, 8.54566 49.459046, 8.541401 49.460617, 8.538883 49.461494, 8.536987 49.462113, 8.534684 49.462834, 8.532597000000001 49.463467, 8.532184000000001 49.463587, 8.525243 49.465613, 8.524392000000001 49.465861, 8.521769000000001 49.466617, 8.521280000000001 49.46676, 8.520127 49.467096, 8.519519000000001 49.46728, 8.518755000000001 49.467521, 8.518205999999999 49.467697, 8.517436 49.467949, 8.515243 49.468715, 8.513648 49.469316, 8.513043 49.469541, 8.512203 49.46987, 8.511652 49.470086, 8.510894 49.470383, 8.510351999999999 49.470595, 8.510023 49.470725, 8.509153 49.471065, 8.508917 49.471158, 8.508884 49.471171, 8.508834 49.471191, 8.508721 49.471235, 8.508414 49.471355, 8.508175 49.471449, 8.506772 49.471999, 8.505369999999999 49.472567, 8.504719 49.472842, 8.503902 49.473187, 8.503565999999999 49.473482, 8.503444 49.473581, 8.503234000000001 49.473675, 8.503328 49.473585, 8.503310000000001 49.47351, 8.503244 49.473481, 8.503204999999999 49.473479, 8.502974 49.473571, 8.502096999999999 49.473922, 8.501573 49.47413, 8.500897 49.474397, 8.500875000000001 49.474405, 8.500653 49.474499, 8.500336000000001 49.474607, 8.500158000000001 49.474668, 8.499948 49.474744, 8.499604 49.474875, 8.499018 49.475107, 8.497546 49.475689, 8.497325999999999 49.475776, 8.496081999999999 49.476267, 8.495756 49.4764, 8.495558000000001 49.476494, 8.495494000000001 49.476529, 8.495411000000001 49.476579, 8.495008 49.476898, 8.494655 49.477211, 8.494495000000001 49.477326, 8.494275 49.477445, 8.494135999999999 49.4775, 8.494038 49.477533, 8.493796 49.477596, 8.493509 49.477634, 8.492819000000001 49.477666, 8.492727 49.477669, 8.492459999999999 49.477726, 8.492335000000001 49.47776, 8.492224999999999 49.477789, 8.492044999999999 49.477843, 8.491925 49.47788, 8.491845 49.477906, 8.491809 49.477917, 8.491718000000001 49.477947, 8.491663000000001 49.477966, 8.491636 49.477975, 8.491466000000001 49.47803, 8.490283 49.478492, 8.489067 49.478964, 8.488569999999999 49.479158, 8.488534 49.479172, 8.488451 49.479204, 8.488174000000001 49.479312, 8.488059 49.479355, 8.487817 49.47945, 8.4877 49.479496, 8.487469000000001 49.479586, 8.487379000000001 49.479621, 8.486383999999999 49.480008, 8.485887999999999 49.480201, 8.484766 49.480637, 8.484348000000001 49.480799, 8.48424 49.480842, 8.484133999999999 49.480883, 8.483934 49.480961, 8.483840000000001 49.480997, 8.482898 49.481363, 8.481835 49.481773, 8.481555 49.481883, 8.481107 49.482059, 8.480567000000001 49.482271, 8.480138999999999 49.482439, 8.479950000000001 49.482513, 8.479801 49.482571, 8.479592 49.482653, 8.479539000000001 49.482674, 8.478363999999999 49.483135, 8.478241000000001 49.483183, 8.478204 49.483207, 8.478171 49.48323, 8.478154999999999 49.483253, 8.478147999999999 49.483286, 8.478152 49.483317, 8.478192999999999 49.483538, 8.478141000000001 49.483757, 8.478092999999999 49.483846, 8.478005 49.483947, 8.477859 49.48408, 8.477729999999999 49.484159, 8.477594 49.484227, 8.477062999999999 49.484434, 8.476509 49.484648, 8.476418000000001 49.484683, 8.476265 49.484742, 8.476065 49.484818, 8.475704 49.484956, 8.475614999999999 49.48499, 8.475436999999999 49.485055, 8.475349 49.485081, 8.475224000000001 49.485111, 8.475152 49.485137, 8.475042 49.485183, 8.474971999999999 49.48521, 8.474888999999999 49.485243, 8.474812 49.485273, 8.474710999999999 49.485312, 8.474577999999999 49.485364, 8.474391000000001 49.485437, 8.473621 49.485738, 8.473551 49.485765, 8.473447999999999 49.485805, 8.473224999999999 49.485892, 8.473158 49.485918, 8.471007999999999 49.486758, 8.470953 49.486779, 8.470719000000001 49.486866, 8.470115 49.4871, 8.469303 49.487415, 8.468487 49.487733, 8.467744 49.488019, 8.467649 49.488045, 8.467497 49.488087, 8.466792 49.488367, 8.466773999999999 49.488374, 8.466754 49.488382, 8.466704 49.488401, 8.466169000000001 49.48861, 8.465909 49.488711, 8.465431000000001 49.488193, 8.465351999999999 49.48811, 8.465343000000001 49.4881, 8.465332999999999 49.488089, 8.465039000000001 49.487769)'::geometry AS geom),
    /*-- Extract its points
    (SELECT (ST_DumpPoints(geom)).geom AS geom FROM line),*/
    cells AS
    -- Get DEM elevation for each
    (SELECT p.geom AS geom, ST_Value(r.rast, 1, p.geom) AS val
     FROM "50_tiles" r,
     (SELECT (ST_DumpPoints(geom)).geom AS geom FROM line) as p
     WHERE ST_Intersects(r.rast, p.geom)),
    -- Instantiate 3D points
  points3d AS
    (SELECT ST_SetSRID(ST_MakePoint(ST_X(geom), ST_Y(geom), val), 4326) AS geom FROM cells)
-- Build 3D line from 3D points
SELECT ST_MakeLine(geom) FROM points3d;
/*CREATE TABLE temp AS SELECT ST_MakeLine(geom) FROM points3d;*/
