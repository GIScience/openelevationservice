EXPLAIN (ANALYZE, TIMING OFF)
 WITH line AS
    -- From an arbitrary line
    (SELECT 'SRID=4326;LINESTRING (8.685477000000001 49.405781, 8.685589 49.405842, 8.685650000000001 49.405872, 8.685734 49.405909, 8.685746 49.405891, 8.685803999999999 49.405844, 8.685981 49.405839, 8.686223999999999 49.405279, 8.686108000000001 49.405259, 8.685530999999999 49.40516, 8.685421 49.405141, 8.685323 49.40516, 8.685238999999999 49.405181, 8.685187000000001 49.405196, 8.685051 49.405267, 8.685019 49.405378, 8.685022 49.405409, 8.685069 49.405456, 8.685101 49.405489, 8.685121000000001 49.405571, 8.685121000000001 49.405645, 8.685062 49.405752, 8.684972999999999 49.405815, 8.68483 49.405876, 8.684715000000001 49.405921, 8.684699 49.405927, 8.684561 49.406013, 8.684491 49.406126, 8.684438 49.40624, 8.684411000000001 49.406483, 8.684383 49.406743, 8.684365 49.406959, 8.684348999999999 49.407323, 8.684326 49.407547, 8.684347000000001 49.407683, 8.684353 49.407764, 8.684353 49.407797, 8.684350999999999 49.407807, 8.684339 49.407859, 8.683949999999999 49.407865, 8.68365 49.407868, 8.683058000000001 49.407872, 8.681827999999999 49.407903, 8.681108999999999 49.407921, 8.679010999999999 49.407947, 8.678853999999999 49.407949, 8.678006999999999 49.407962, 8.677306 49.407973, 8.677060000000001 49.407977, 8.676970000000001 49.407978, 8.676932000000001 49.407978, 8.676904 49.407978, 8.676852999999999 49.407979, 8.676774999999999 49.40798, 8.676735000000001 49.40798, 8.676696 49.40798, 8.676496999999999 49.40798, 8.676456999999999 49.407979, 8.676126999999999 49.407975, 8.676048 49.407973, 8.675522000000001 49.40796, 8.675314999999999 49.407941, 8.674925999999999 49.407936, 8.674797 49.40794, 8.674702999999999 49.407948, 8.674509 49.407968, 8.674381 49.407979, 8.674255 49.407988, 8.67417 49.407992, 8.674058 49.407995, 8.673818000000001 49.408005, 8.673627 49.408005, 8.673568 49.408004, 8.672806 49.408, 8.672737 49.408001, 8.672599 49.408003, 8.67229 49.408024, 8.672247 49.408027, 8.671775 49.40804, 8.670403 49.408065, 8.670261999999999 49.408068, 8.669843999999999 49.408076, 8.669506 49.408105, 8.669358000000001 49.408117, 8.669314999999999 49.408121, 8.669199000000001 49.408136, 8.668884 49.408169, 8.668654 49.408188, 8.667877000000001 49.408226, 8.666931999999999 49.408266, 8.666380999999999 49.408316, 8.665452 49.408428, 8.664576 49.408594, 8.663678000000001 49.408791, 8.662762000000001 49.409012, 8.658257000000001 49.410211, 8.652422 49.411782, 8.652058 49.411874, 8.649709 49.412468, 8.64944 49.412539, 8.648999999999999 49.412656, 8.646922 49.413204, 8.645289 49.413635, 8.642702 49.414328, 8.642225 49.414455, 8.640844 49.414878, 8.640067999999999 49.415151, 8.639875 49.415278, 8.639756999999999 49.41533, 8.639014 49.415661, 8.638140999999999 49.416059, 8.636801 49.416674, 8.636048000000001 49.417057, 8.634088 49.418167, 8.632631 49.419004, 8.628508 49.421361, 8.627617000000001 49.421818, 8.626923 49.422113, 8.625429 49.422976, 8.623995000000001 49.423801, 8.615728000000001 49.428537, 8.604960999999999 49.434698, 8.602658999999999 49.436017, 8.598223000000001 49.438559, 8.597358 49.439055, 8.596363 49.439626, 8.595212999999999 49.440271, 8.594182 49.440801, 8.593505 49.441122, 8.592275000000001 49.441652, 8.591258 49.442062, 8.589926 49.442552, 8.588939999999999 49.442919, 8.587574999999999 49.443426, 8.586888999999999 49.443682, 8.583408 49.444976, 8.582634000000001 49.445265, 8.58216 49.445442, 8.581664999999999 49.445625, 8.579143999999999 49.446567, 8.577284000000001 49.447259, 8.577090999999999 49.447331, 8.575593 49.447893, 8.575284 49.448006, 8.574851000000001 49.448168, 8.572759 49.448947, 8.571565 49.449391, 8.570582999999999 49.449758, 8.567769 49.450807, 8.565208 49.451761, 8.549555 49.457593, 8.545971 49.458929, 8.54566 49.459046, 8.541401 49.460617, 8.538883 49.461494, 8.536987 49.462113, 8.534684 49.462834, 8.532597000000001 49.463467, 8.532184000000001 49.463587, 8.525243 49.465613, 8.524392000000001 49.465861, 8.521769000000001 49.466617, 8.521280000000001 49.46676, 8.520127 49.467096, 8.519519000000001 49.46728, 8.518755000000001 49.467521, 8.518205999999999 49.467697, 8.517436 49.467949, 8.515243 49.468715, 8.513648 49.469316, 8.513043 49.469541, 8.512203 49.46987, 8.511652 49.470086, 8.510894 49.470383, 8.510351999999999 49.470595, 8.510023 49.470725, 8.509153 49.471065, 8.508917 49.471158, 8.508884 49.471171, 8.508834 49.471191, 8.508721 49.471235, 8.508414 49.471355, 8.508175 49.471449, 8.506772 49.471999, 8.505369999999999 49.472567, 8.504719 49.472842, 8.503902 49.473187, 8.503565999999999 49.473482, 8.503444 49.473581, 8.503234000000001 49.473675, 8.503328 49.473585, 8.503310000000001 49.47351, 8.503244 49.473481, 8.503204999999999 49.473479, 8.502974 49.473571, 8.502096999999999 49.473922, 8.501573 49.47413, 8.500897 49.474397, 8.500875000000001 49.474405, 8.500653 49.474499, 8.500336000000001 49.474607, 8.500158000000001 49.474668, 8.499948 49.474744, 8.499604 49.474875, 8.499018 49.475107, 8.497546 49.475689, 8.497325999999999 49.475776, 8.496081999999999 49.476267, 8.495756 49.4764, 8.495558000000001 49.476494, 8.495494000000001 49.476529, 8.495411000000001 49.476579, 8.495008 49.476898, 8.494655 49.477211, 8.494495000000001 49.477326, 8.494275 49.477445, 8.494135999999999 49.4775, 8.494038 49.477533, 8.493796 49.477596, 8.493509 49.477634, 8.492819000000001 49.477666, 8.492727 49.477669, 8.492459999999999 49.477726, 8.492335000000001 49.47776, 8.492224999999999 49.477789, 8.492044999999999 49.477843, 8.491925 49.47788, 8.491845 49.477906, 8.491809 49.477917, 8.491718000000001 49.477947, 8.491663000000001 49.477966, 8.491636 49.477975, 8.491466000000001 49.47803, 8.490283 49.478492, 8.489067 49.478964, 8.488569999999999 49.479158, 8.488534 49.479172, 8.488451 49.479204, 8.488174000000001 49.479312, 8.488059 49.479355, 8.487817 49.47945, 8.4877 49.479496, 8.487469000000001 49.479586, 8.487379000000001 49.479621, 8.486383999999999 49.480008, 8.485887999999999 49.480201, 8.484766 49.480637, 8.484348000000001 49.480799, 8.48424 49.480842, 8.484133999999999 49.480883, 8.484757999999999 49.481562, 8.485709999999999 49.482597, 8.485766999999999 49.482659, 8.487318999999999 49.48438, 8.48738 49.484449, 8.487474000000001 49.484556, 8.487499 49.484584, 8.487565 49.48466, 8.487410000000001 49.484771, 8.487268 49.484883, 8.487234000000001 49.4849, 8.487209999999999 49.484911, 8.486974 49.485012, 8.484650999999999 49.485914, 8.483340999999999 49.486423, 8.483198 49.486478, 8.483131999999999 49.486504, 8.482260999999999 49.486842, 8.481631999999999 49.487087, 8.481032000000001 49.48732, 8.479706999999999 49.487834, 8.479626 49.48792, 8.479604999999999 49.487974, 8.479574 49.488056, 8.479844999999999 49.488301, 8.479829000000001 49.488377, 8.479768 49.488436, 8.479649 49.488492, 8.479571 49.48853, 8.479333 49.488652, 8.479044999999999 49.488752, 8.478895 49.488771, 8.478721999999999 49.488772, 8.478642000000001 49.488769, 8.476383 49.488701, 8.476210999999999 49.488696, 8.476176000000001 49.488904, 8.476117 49.489132, 8.476108 49.489165, 8.476093000000001 49.489223, 8.476068 49.489308, 8.47602 49.48946, 8.475792999999999 49.489969, 8.475724 49.490114, 8.475583 49.490362, 8.475443 49.490584, 8.475429999999999 49.490605, 8.475296999999999 49.490786, 8.475185 49.490916, 8.47503 49.491078, 8.474966999999999 49.491135, 8.474905 49.491183, 8.474284000000001 49.491664, 8.473833000000001 49.491976, 8.473488 49.492192, 8.473152000000001 49.492382, 8.473031000000001 49.492439, 8.472991 49.492458, 8.472915 49.492494, 8.47279 49.492551, 8.472670000000001 49.492606, 8.472083 49.492868, 8.472047 49.492886, 8.47194 49.492942, 8.471798 49.493037, 8.471690000000001 49.493127, 8.47157 49.493232, 8.471557000000001 49.49324, 8.471321 49.493365, 8.471157 49.493424, 8.471078 49.493442, 8.470981999999999 49.493459, 8.470822999999999 49.493476, 8.470628 49.493496, 8.470488 49.493518, 8.470444000000001 49.493528, 8.470325000000001 49.49356, 8.470001999999999 49.493658, 8.469721 49.49371, 8.469341 49.493779, 8.469101999999999 49.493822, 8.468786 49.493874, 8.468683 49.493946, 8.46852 49.494026, 8.46846 49.494074, 8.468446999999999 49.494132, 8.468425999999999 49.494223, 8.468401 49.494316, 8.468347 49.49439, 8.468227000000001 49.494457, 8.466657 49.495033, 8.466471 49.495078, 8.466283000000001 49.495114, 8.466218 49.495127, 8.46617 49.495137, 8.465266 49.49532, 8.464948 49.495389, 8.464683000000001 49.495444, 8.464153 49.495556, 8.463317 49.495748, 8.462289 49.495983, 8.4621 49.496032, 8.461764000000001 49.49612, 8.461344 49.496231, 8.461122 49.496313, 8.460826000000001 49.496452, 8.46048 49.496631, 8.460362 49.496713, 8.460279999999999 49.496766, 8.460118 49.496869, 8.460046999999999 49.496928, 8.459975999999999 49.497049, 8.459921 49.497153, 8.459832 49.497236, 8.459787 49.49732, 8.459667 49.497528, 8.459493999999999 49.497687, 8.458111000000001 49.49827, 8.457966000000001 49.498332, 8.457756 49.498422, 8.457286 49.498628, 8.457157 49.498683, 8.457095000000001 49.498709, 8.456906999999999 49.498795, 8.456422999999999 49.499007, 8.456206999999999 49.499101, 8.456007 49.499188, 8.455548 49.499339, 8.455104 49.499433, 8.454737 49.499509, 8.454331 49.499637, 8.454053999999999 49.499748, 8.453829000000001 49.499852, 8.453563000000001 49.499979, 8.453104 49.50021, 8.452970000000001 49.500282, 8.452678000000001 49.50043, 8.451383999999999 49.501068, 8.450869000000001 49.501342, 8.450642999999999 49.501458, 8.450195000000001 49.501688, 8.449306 49.502178, 8.447679000000001 49.503108, 8.447566 49.503178)'::geometry AS geom),
/*  points2d AS
    -- Extract its points
    (SELECT (ST_DumpPoints(geom)).geom AS geom FROM line),*/
  cells AS
    -- Get DEM elevation for each
    (SELECT p.geom AS geom, ST_Value(oes_cgiar.rast, 1, p.geom) AS val
     FROM oes_cgiar,
         (SELECT (ST_DumpPoints(geom)).geom AS geom FROM line) as p
     WHERE ST_Intersects(oes_cgiar.rast, p.geom)),
    -- Instantiate 3D points
  points3d AS
    (SELECT ST_SetSRID(ST_MakePoint(ST_X(geom), ST_Y(geom), val), 4326) AS geom FROM cells)
-- Build 3D line from 3D points
SELECT ST_MakeLine(geom) FROM points3d;
/*CREATE TABLE temp AS SELECT ST_MakeLine(geom) FROM points3d;*/
